{"version":3,"file":"EditorView.js","sourceRoot":"","sources":["../../lib/ui/EditorView.ts"],"names":[],"mappings":"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","sourcesContent":["'use babel';\n/*!\n * Atom Bugs\n * Copyright(c) 2017 Williams Medina <williams.medinaa@gmail.com>\n * MIT Licensed\n */\nimport { BreakpointManager } from '../BreakpointManager';\nimport { EventEmitter }  from 'events';\n\nexport class EditorView {\n\n  private currentEditor: any;\n  private currentBreakMarker: any;\n  private currentExpressionMarker: any;\n  private currentEvaluationMarker: any;\n  private breakpointHandler: Function;\n  private expressionHandler: Function;\n  private evaluateHandler: any;\n  private events: EventEmitter;\n\n  constructor (private breakpointManager: BreakpointManager) {\n    this.events = new EventEmitter();\n    this.breakpointHandler = this.breakpointListener.bind(this);\n    this.expressionHandler = this.expressionListener.bind(this);\n  }\n\n  destroy () {\n    this.currentBreakMarker = null;\n    this.currentExpressionMarker = null;\n    this.currentEvaluationMarker = null;\n    this.removeMarkers();\n  }\n\n  didEvaluateExpression (cb: Function) {\n    this.events.on('evaluateExpression', cb);\n  }\n\n  createBreakMarker (editor, lineNumber: number) {\n    this.removeBreakMarker();\n    let range = [[lineNumber - 1, 0], [lineNumber - 1, 0]];\n    this.currentBreakMarker = editor.markBufferRange(range);\n    editor.decorateMarker(this.currentBreakMarker, {\n      type: 'line',\n      class: 'bugs-break-line'\n    })\n  }\n\n  removeMarkers () {\n    this.removeBreakMarker();\n    this.removeExpressionMarker();\n    this.removeEvaluationMarker();\n  }\n\n  removeBreakMarker () {\n    if (this.currentBreakMarker) {\n      this.currentBreakMarker.destroy();\n    }\n  }\n\n  removeExpressionMarker () {\n    if (this.currentExpressionMarker) {\n      this.currentExpressionMarker.destroy();\n    }\n  }\n\n  addFeatures (editor) {\n    // Observe active editor\n    atom.workspace['observeActivePaneItem']((editor) => {\n      if (this.currentEditor && this.currentEditor.editorElement) {\n        // remove breakpoint handler\n        this.currentEditor.editorElement.removeEventListener('click', this.breakpointHandler);\n        this.currentEditor.editorElement.removeEventListener('mousemove', this.expressionHandler);\n        // remove expression evaluator\n      }\n      if (editor && editor.getPath && editor.editorElement) {\n        this.currentEditor = editor;\n        // add breakpoint handler\n        this.currentEditor.editorElement.addEventListener('click', this.breakpointHandler)\n        this.currentEditor.editorElement.addEventListener('mousemove', this.expressionHandler);\n      }\n    })\n  }\n\n  private breakpointListener (e: MouseEvent) {\n    let element = e.target as HTMLElement;\n    if (element.classList.contains('line-number')) {\n      // toggle breakpoints\n      let sourceFile = this.currentEditor.getPath();\n      let lineNumber = Number(element.textContent)\n      let exists = this.breakpointManager.getBreakpoint(sourceFile, lineNumber)\n      if (exists) {\n        this.breakpointManager.removeBreakpoint(exists);\n      } else {\n        let range = [[lineNumber - 1, 0], [lineNumber - 1, 0]]\n        let marker = this.currentEditor.markBufferRange(range)\n        let decorator = this.currentEditor.decorateMarker(marker, {\n          type: 'line-number',\n          class: 'bugs-breakpoint'\n        })\n        this.breakpointManager.addBreakpoint(marker, lineNumber, sourceFile)\n      }\n    }\n  }\n\n  private  expressionListener (e: MouseEvent) {\n    let sourceFile = this.currentEditor.getPath();\n    let lines = this.currentEditor.editorElement.querySelector('.lines');\n    var clientX = e.clientX;\n    var clientY = e.clientY;\n    let clientRect = lines.getBoundingClientRect();\n    let screenPosition = this.currentEditor.screenPositionForPixelPosition({\n      top: (clientY - clientRect.top) + this.currentEditor.editorElement.getScrollTop(),\n      left: (clientX - clientRect.left) + this.currentEditor.editorElement.getScrollLeft()\n    });\n    let bufferPosition = this.currentEditor.bufferPositionForScreenPosition(screenPosition);\n    let prevRow = this.currentEditor.buffer.previousNonBlankRow(bufferPosition.row);\n    let endRow = this.currentEditor.buffer.nextNonBlankRow(bufferPosition.row);\n    if (!endRow) {\n      endRow = bufferPosition.row;\n    }\n    let startWord = bufferPosition;\n    let endWord = bufferPosition;\n    this.currentEditor.scanInBufferRange(/[ \\,\\{\\}\\(\\;\\)\\[\\]^\\n]+/gm, [[prevRow, 0], bufferPosition], (s) => {\n      if (s.matchText) {\n        startWord = s.range.end;\n      }\n    })\n    this.currentEditor.scanInBufferRange(/[ \\,\\{\\}\\(\\.\\;\\)\\[\\]\\n]+/g, [bufferPosition, [endRow, 50]], (s) => {\n      if (s.matchText) {\n        endWord = s.range.start;\n        s.stop();\n      }\n    })\n    let scanRange = [startWord, endWord];\n    let expression = this.currentEditor.getTextInBufferRange(scanRange);\n    clearTimeout(this.evaluateHandler)\n    this.evaluateHandler = setTimeout(() => {\n      if (expression && String(expression).trim().length > 0) {\n        this.events.emit('evaluateExpression', expression, scanRange);\n      }\n    }, 250);\n  }\n  addEvaluationMarker (result, range) {\n    // highlight expression\n    this.removeExpressionMarker();\n    this.currentExpressionMarker = this.currentEditor.markBufferRange(range)\n    this.currentEditor.decorateMarker(this.currentExpressionMarker, {\n      type: 'highlight',\n      class: 'bugs-expression'\n    })\n    // overlay inspector\n    this.removeEvaluationMarker();\n    let element = document.createElement('atom-bugs-inspector');\n    element.setAttribute('tabindex', '-1');\n    element.className = 'native-key-bindings';\n    element.innerHTML = JSON.stringify(result);\n    this.currentEvaluationMarker = this.currentEditor.markBufferRange(range);\n    this.currentEditor.decorateMarker(this.currentEvaluationMarker, {\n      type: 'overlay',\n      position: 'head',\n      class: 'bugs-expression-overlay',\n      item: element\n    });\n    setTimeout(() => {\n      element.parentElement.addEventListener('mouseout', () => {\n        this.removeEvaluationMarker();\n      });\n    }, 100);\n  }\n  removeEvaluationMarker () {\n    if (this.currentEvaluationMarker) {\n      this.currentEvaluationMarker.destroy();\n    }\n  }\n}\n"]}